name: Sample CI
on: [ push, pull_request ]

permissions:
  contents: read

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: '3.12'
          cache: pip
          cache-dependency-path: functions/anomali-ioc-ingest/requirements.txt

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        working-directory: functions/anomali-ioc-ingest

      - name: Run Python tests
        run: |
          if [ -f "test_main.py" ]; then
            echo "Running Python tests"
            python -m pytest test_main.py -v
          else
            echo "No test_main.py found, skipping Python tests"
          fi
        working-directory: functions/anomali-ioc-ingest

      - name: Setup Go
        uses: actions/setup-go@3041bf56c941b39c61721a86cd11f3bb1338122a  # v5.2.0
        with:
          go-version: '1.23'
          cache-dependency-path: functions/anomali-ioc-ingest/go.sum

      - name: Run Go tests
        run: |
          if [ -f "go.mod" ]; then
            echo "Running Go tests"
            go test -v ./...
          else
            echo "No go.mod found, skipping Go tests"
          fi
        working-directory: functions/anomali-ioc-ingest

      - name: Verify Go function builds
        run: |
          if [ -f "go.mod" ]; then
            echo "Building Go function"
            go build -o /dev/null .
            echo "âœ… Go function builds successfully"
          else
            echo "No go.mod found, skipping Go build"
          fi
        working-directory: functions/anomali-ioc-ingest
